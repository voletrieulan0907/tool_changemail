name: Build and Release
on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4
    
    - uses: actions/setup-python@v5
      with:
        python-version: '3.9'
    
    - name: Install PyInstaller
      run: pip install pyinstaller
    
    - name: Install additional dependencies (if needed)
      run: |
        # ThÃªm cÃ¡c package cáº§n thiáº¿t á»Ÿ Ä‘Ã¢y
        # pip install requests
        # pip install tkinter (usually built-in)
      shell: powershell
    
    - name: Build application (folder mode)
      run: |
        pyinstaller --onedir --windowed --name="MyApp" app.py
        # ThÃªm options khÃ¡c náº¿u cáº§n:
        # --icon=icon.ico (náº¿u cÃ³ icon)
        # --add-data="data;data" (náº¿u cÃ³ data files)
      shell: powershell
    
    - name: Create folder structure
      run: |
        # Táº¡o cÃ¡c folder chuyÃªn nghiá»‡p
        New-Item -ItemType Directory -Force -Path "dist/MyApp/internal"
        New-Item -ItemType Directory -Force -Path "dist/MyApp/config" 
        New-Item -ItemType Directory -Force -Path "dist/MyApp/data"
        New-Item -ItemType Directory -Force -Path "dist/MyApp/logs"
        
        # Copy files bá»• sung (náº¿u cÃ³)
        if (Test-Path "README.md") { Copy-Item "README.md" "dist/MyApp/" }
        if (Test-Path "config.json") { Copy-Item "config.json" "dist/MyApp/config/" }
        
        # Táº¡o file version
        $version = "${{ github.run_number }}.0.0"
        "App Version: $version`nBuild: ${{ github.sha }}" | Out-File -FilePath "dist/MyApp/version.txt"
        
        # Táº¡o file thÃ´ng tin
        @"
MyApp - Version $version

Cáº¥u trÃºc thÆ° má»¥c:
â”œâ”€â”€ MyApp.exe          # á»¨ng dá»¥ng chÃ­nh
â”œâ”€â”€ internal/          # CÃ¡c module ná»™i bá»™
â”œâ”€â”€ config/            # File cáº¥u hÃ¬nh
â”œâ”€â”€ data/              # Dá»¯ liá»‡u á»©ng dá»¥ng
â”œâ”€â”€ logs/              # File log
â””â”€â”€ _internal/         # PyInstaller files

CÃ¡ch sá»­ dá»¥ng:
1. Cháº¡y MyApp.exe
2. Cáº¥u hÃ¬nh trong folder config/
3. Dá»¯ liá»‡u Ä‘Æ°á»£c lÆ°u trong folder data/
"@ | Out-File -FilePath "dist/MyApp/README.txt"
      shell: powershell
    
    - name: Create ZIP package
      run: |
        cd dist
        Compress-Archive -Path MyApp -DestinationPath MyApp-v${{ github.run_number }}-windows.zip
      shell: powershell
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: MyApp-windows-build
        path: dist/MyApp-v${{ github.run_number }}-windows.zip
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: "v1.0.${{ github.run_number }}"
        name: "MyApp v1.0.${{ github.run_number }}"
        files: dist/MyApp-v${{ github.run_number }}-windows.zip
        draft: false
        prerelease: false
        body: |
          ## ğŸš€ MyApp v1.0.${{ github.run_number }}
          
          ### ğŸ“¦ Táº£i xuá»‘ng
          - **MyApp-v${{ github.run_number }}-windows.zip** - PhiÃªn báº£n Windows (folder structure)
          
          ### ğŸ“ Cáº¥u trÃºc
          ```
          MyApp/
          â”œâ”€â”€ MyApp.exe          # á»¨ng dá»¥ng chÃ­nh
          â”œâ”€â”€ internal/          # Module ná»™i bá»™
          â”œâ”€â”€ config/            # Cáº¥u hÃ¬nh
          â”œâ”€â”€ data/              # Dá»¯ liá»‡u
          â”œâ”€â”€ logs/              # Log files
          â””â”€â”€ _internal/         # PyInstaller dependencies
          ```
          
          ### ğŸ”§ CÃ i Ä‘áº·t
          1. Táº£i file ZIP
          2. Giáº£i nÃ©n vÃ o thÆ° má»¥c báº¥t ká»³
          3. Cháº¡y `MyApp.exe`
          
          ### ğŸ“Š ThÃ´ng tin build
          - **Commit:** ${{ github.sha }}
          - **Build number:** ${{ github.run_number }}
          - **Build time:** ${{ github.event.head_commit.timestamp }}
          - **Commit message:** ${{ github.event.head_commit.message }}
          
          ### ğŸ”„ API Update Check
          Sá»­ dá»¥ng endpoint: `https://api.github.com/repos/${{ github.repository }}/releases/latest`
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
